<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smash or Pass - Cesaris's Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
        }
        
        .logo {
            max-width: 300px;
            margin: 0 auto 20px;
        }
        
        .logo-img {
            width: 100%;
            height: auto;
        }
        
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
            font-weight: bold;
        }
        
        .tab.active {
            background: #6e8efb;
            color: white;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .tab-content.active {
            display: block;
        }

        /* Upload Steps */
        .upload-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 20px;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .step.active .step-number {
            background: #6e8efb;
        }
        
        .step-content {
            display: none;
            text-align: center;
        }
        
        .step-content.active {
            display: block;
        }
        
        .gender-selection {
            margin: 20px 0;
        }
        
        .gender-btn {
            background: #f0f0f0;
            border: 2px solid #ddd;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            min-width: 150px;
        }
        
        .gender-btn.active {
            background: #6e8efb;
            color: white;
            border-color: #6e8efb;
        }
        
        .gender-btn.male.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }
        
        .gender-btn.female.active {
            background: #e91e63;
            border-color: #e91e63;
        }
        
        .upload-area {
            border: 2px dashed #6e8efb;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            background-color: #f8f9ff;
        }
        
        .preview-container {
            margin: 20px 0;
            text-align: center;
        }
        
        .preview-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .btn-primary {
            background: #6e8efb;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #5a7dfa;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        /* Voting Steps */
        .vote-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .vote-step-content {
            display: none;
            text-align: center;
        }
        
        .vote-step-content.active {
            display: block;
        }
        
        .photo-container {
            position: relative;
            max-width: 400px;
            margin: 0 auto 30px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .current-photo {
            width: 100%;
            height: 500px;
            object-fit: cover;
            display: block;
        }
        
        .vote-buttons-single {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .smash-btn-single, .pass-btn-single {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .smash-btn-single {
            background: #4CAF50;
            color: white;
        }
        
        .smash-btn-single:hover {
            background: #45a049;
        }
        
        .pass-btn-single {
            background: #f44336;
            color: white;
        }
        
        .pass-btn-single:hover {
            background: #da190b;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .back-button {
            background: #6e8efb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Vote History */
        .vote-history {
            margin-top: 30px;
        }
        
        .history-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .history-photo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 10px;
            margin-right: 15px;
        }
        
        .history-info {
            flex-grow: 1;
        }
        
        .history-vote {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 20px;
        }
        
        .history-vote.smash {
            background: #4CAF50;
            color: white;
        }
        
        .history-vote.pass {
            background: #f44336;
            color: white;
        }
        
        .change-vote-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #4CAF50;
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <img src="data:image/png;base64,YOUR_LOGO_BASE64_HERE" alt="Smash or Pass" class="logo-img">
            </div>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-tab="upload">Carica Foto</div>
            <div class="tab" data-tab="vote">Vota Foto</div>
        </div>
        
        <!-- Upload Tab -->
        <div class="tab-content active" id="upload-tab">
            <div class="upload-steps">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <div>Scegli Genere</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div>Carica Foto</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div>Conferma</div>
                </div>
            </div>
            
            <div class="step-content active" id="step1-content">
                <h3>Step 1: Seleziona il genere</h3>
                <div class="gender-selection">
                    <button class="gender-btn male" onclick="selectGender('male')">üë¶ Ragazzo</button>
                    <button class="gender-btn female" onclick="selectGender('female')">üëß Ragazza</button>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="goToStep(2)" id="nextToStep2" disabled>Avanti</button>
                </div>
            </div>
            
            <div class="step-content" id="step2-content">
                <h3>Step 2: Carica la tua foto</h3>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <h3>Clicca qui per selezionare una foto</h3>
                    <p>Dimensione massima: 5MB</p>
                    <input type="file" id="fileInput" accept="image/*" style="display:none">
                </div>
                <div class="preview-container">
                    <img id="previewImage" class="preview-image" style="display:none">
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="goToStep(1)">Indietro</button>
                    <button class="btn btn-primary" onclick="goToStep(3)" id="nextToStep3" disabled>Avanti</button>
                </div>
            </div>
            
            <div class="step-content" id="step3-content">
                <h3>Step 3: Conferma</h3>
                <div class="preview-container">
                    <img id="confirmPreviewImage" class="preview-image">
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="goToStep(2)">Modifica</button>
                    <button class="btn btn-primary" onclick="uploadPhoto()" id="uploadBtn">Carica Foto</button>
                </div>
            </div>
        </div>

        <!-- Vote Tab -->
        <div class="tab-content" id="vote-tab">
            <div class="vote-steps">
                <div class="step active" id="vote-step1">
                    <div class="step-number">1</div>
                    <div>Scegli Genere</div>
                </div>
                <div class="step" id="vote-step2">
                    <div class="step-number">2</div>
                    <div>Vota</div>
                </div>
                <div class="step" id="vote-step3">
                    <div class="step-number">3</div>
                    <div>Cronologia</div>
                </div>
            </div>

            <!-- Step 1: Choose Gender -->
            <div class="vote-step-content active" id="vote-step1-content">
                <h3>Scegli il genere da votare</h3>
                <div class="gender-selection">
                    <button class="gender-btn male active" onclick="selectVoteGender('male')">üë¶ Ragazzi</button>
                    <button class="gender-btn female" onclick="selectVoteGender('female')">üëß Ragazze</button>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="goToVoteStep(2)">Inizia a Votare</button>
                </div>
            </div>

            <!-- Step 2: Voting -->
            <div class="vote-step-content" id="vote-step2-content">
                <div id="singlePhotoView">
                    <div class="loading">Caricamento foto...</div>
                </div>
                <div class="navigation-buttons">
                    <button class="back-button" onclick="goToVoteStep(1)">‚Üê Cambia Genere</button>
                    <button class="back-button" onclick="goToVoteStep(3)">Vedi Cronologia ‚Üí</button>
                </div>
            </div>

            <!-- Step 3: History -->
            <div class="vote-step-content" id="vote-step3-content">
                <h3>Le tue decisioni</h3>
                <div id="voteHistory"></div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="goToVoteStep(2)">‚Üê Torna a Votare</button>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // Configurazione Supabase
        const SUPABASE_URL = 'https://rreyuxxnyhhahwkjxfiv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyZXl1eHhueWhoYWh3a2p4Zml2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjIyNDgsImV4cCI6MjA3ODU5ODI0OH0.F_ZnqK10o8h-IY23_g9RzkPHqQVbpAvjQmw0awlApBE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Variabili globali
        let selectedGender = null;
        let selectedFile = null;
        let currentVoteGender = 'male';
        let currentPhotos = [];
        let currentPhotoIndex = 0;
        let voteHistory = JSON.parse(localStorage.getItem('voteHistory') || '{}');

        // Gestione tab
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });

        // Upload Steps
        function goToStep(step) {
            document.querySelectorAll('.step-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`step${step}-content`).classList.add('active');
            
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.remove('active');
                if (index + 1 === step) stepEl.classList.add('active');
            });

            if (step === 3) {
                document.getElementById('confirmPreviewImage').src = document.getElementById('previewImage').src;
            }
        }

        function selectGender(gender) {
            selectedGender = gender;
            document.querySelectorAll('#step1-content .gender-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('nextToStep2').disabled = false;
        }

        // File handling
        document.getElementById('fileInput').addEventListener('change', function(e) {
            if (e.target.files.length) handleFileSelection(e.target.files[0]);
        });

        function handleFileSelection(file) {
            if (!file.type.match('image.*') || file.size > 5 * 1024 * 1024) {
                showNotification('File non valido!', true);
                return;
            }
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('previewImage').style.display = 'block';
                document.getElementById('nextToStep3').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        async function uploadPhoto() {
            if (!selectedFile || !selectedGender) return;
            
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Caricamento...';

            try {
                const fileExt = selectedFile.name.split('.').pop();
                const fileName = `${Math.random().toString(36).substring(2)}_${Date.now()}.${fileExt}`;
                
                // Upload a Supabase Storage
                const { error: storageError } = await supabase.storage
                    .from('photo-uploads')
                    .upload(fileName, selectedFile);
                if (storageError) throw storageError;

                // Get URL
                const { data: publicUrlData } = supabase.storage
                    .from('photo-uploads')
                    .getPublicUrl(fileName);

                // Salva nel database
                const { error: dbError } = await supabase
                    .from('photos')
                    .insert([{ 
                        image_url: publicUrlData.publicUrl,
                        gender: selectedGender,
                        smash_count: 0,
                        pass_count: 0
                    }]);
                if (dbError) throw dbError;

                showNotification('Foto caricata!');
                setTimeout(() => {
                    resetUploadForm();
                    goToStep(1);
                }, 2000);

            } catch (error) {
                showNotification('Errore nel caricamento', true);
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Carica Foto';
            }
        }

        function resetUploadForm() {
            selectedFile = null;
            selectedGender = null;
            document.getElementById('previewImage').style.display = 'none';
            document.getElementById('fileInput').value = '';
            document.querySelectorAll('#step1-content .gender-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('nextToStep2').disabled = true;
            document.getElementById('nextToStep3').disabled = true;
        }

        // Voting Steps
        function goToVoteStep(step) {
            document.querySelectorAll('.vote-step-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`vote-step${step}-content`).classList.add('active');
            
            document.querySelectorAll('.vote-steps .step').forEach((stepEl, index) => {
                stepEl.classList.remove('active');
                if (index + 1 === step) stepEl.classList.add('active');
            });

            if (step === 2) loadPhotosForVoting();
            if (step === 3) loadVoteHistory();
        }

        function selectVoteGender(gender) {
            currentVoteGender = gender;
            document.querySelectorAll('#vote-step1-content .gender-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        async function loadPhotosForVoting() {
            try {
                const { data: photos, error } = await supabase
                    .from('photos')
                    .select('*')
                    .eq('gender', currentVoteGender)
                    .order('created_at', { ascending: false });

                currentPhotos = photos || [];
                currentPhotoIndex = 0;
                showCurrentPhoto();

            } catch (error) {
                showNotification('Errore nel caricamento foto', true);
            }
        }

        function showCurrentPhoto() {
            if (currentPhotoIndex >= currentPhotos.length) {
                document.getElementById('singlePhotoView').innerHTML = '<div class="no-photos">Nessuna foto disponibile</div>';
                return;
            }

            const photo = currentPhotos[currentPhotoIndex];
            document.getElementById('singlePhotoView').innerHTML = `
                <div class="photo-container">
                    <img src="${photo.image_url}" class="current-photo">
                </div>
                <div class="vote-buttons-single">
                    <button class="pass-btn-single" onclick="voteCurrentPhoto('pass')">PASS üëé</button>
                    <button class="smash-btn-single" onclick="voteCurrentPhoto('smash')">SMASH üëç</button>
                </div>
            `;
        }

        async function voteCurrentPhoto(voteType) {
            const photo = currentPhotos[currentPhotoIndex];
            const photoId = photo.id;

            try {
                // Salva il voto nella cronologia
                voteHistory[photoId] = voteType;
                localStorage.setItem('voteHistory', JSON.stringify(voteHistory));

                // Aggiorna il database
                const newSmashCount = voteType === 'smash' ? photo.smash_count + 1 : photo.smash_count;
                const newPassCount = voteType === 'pass' ? photo.pass_count + 1 : photo.pass_count;
                
                await supabase
                    .from('photos')
                    .update({ smash_count: newSmashCount, pass_count: newPassCount })
                    .eq('id', photoId);

                showNotification(`Hai votato ${voteType === 'smash' ? 'Smash!' : 'Pass!'}`);
                currentPhotoIndex++;
                showCurrentPhoto();

            } catch (error) {
                showNotification('Errore nel voto', true);
            }
        }

        async function loadVoteHistory() {
            const historyContainer = document.getElementById('voteHistory');
            const votedPhotoIds = Object.keys(voteHistory);
            
            if (votedPhotoIds.length === 0) {
                historyContainer.innerHTML = '<p>Non hai ancora votato nessuna foto</p>';
                return;
            }

            try {
                const { data: photos, error } = await supabase
                    .from('photos')
                    .select('*')
                    .in('id', votedPhotoIds);

                historyContainer.innerHTML = photos.map(photo => `
                    <div class="history-item">
                        <img src="${photo.image_url}" class="history-photo">
                        <div class="history-info">
                            <div>${photo.gender === 'male' ? 'üë¶' : 'üëß'}</div>
                        </div>
                        <span class="history-vote ${voteHistory[photo.id]}">
                            ${voteHistory[photo.id].toUpperCase()}
                        </span>
                        <button class="change-vote-btn" onclick="changeVote('${photo.id}')">
                            Cambia
                        </button>
                    </div>
                `).join('');

            } catch (error) {
                historyContainer.innerHTML = '<p>Errore nel caricamento della cronologia</p>';
            }
        }

        function changeVote(photoId) {
            const currentVote = voteHistory[photoId];
            const newVote = currentVote === 'smash' ? 'pass' : 'smash';
            voteHistory[photoId] = newVote;
            localStorage.setItem('voteHistory', JSON.stringify(voteHistory));
            loadVoteHistory();
            showNotification('Voto cambiato!');
        }

        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${isError ? 'error' : ''}`;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
